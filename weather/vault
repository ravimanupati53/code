---
- name: Publish Terraform module to Terraform Cloud
  hosts: localhost
  vars:
    vault_addr: "https://your-vault-address"
    role_id: "{{ lookup('env', 'VAULT_ROLE_ID') }}"  # Alternatively, fetch from Tower credentials
    secret_id: "{{ lookup('env', 'VAULT_SECRET_ID') }}"  # Alternatively, fetch from Tower credentials
    github_repo: "https://github.com/your-repo/terraform-module"
    terraform_cloud_org: "your-org"
    terraform_cloud_module_name: "your-module-name"
    terraform_cloud_module_provider: "aws"
  tasks:
    - name: Fetch Vault token
      uri:
        url: "{{ vault_addr }}/v1/auth/approle/login"
        method: POST
        body_format: json
        body:
          role_id: "{{ role_id }}"
          secret_id: "{{ secret_id }}"
        return_content: yes
      register: vault_auth_response

    - name: Set Vault token
      set_fact:
        vault_token: "{{ vault_auth_response.json.auth.client_token }}"

    - name: Fetch Terraform Cloud token
      uri:
        url: "{{ vault_addr }}/v1/secret/data/terraform-cloud-token"
        method: GET
        headers:
          "X-Vault-Token": "{{ vault_token }}"
        return_content: yes
      register: terraform_cloud_token_response

    - name: Set Terraform Cloud token
      set_fact:
        terraform_cloud_token: "{{ terraform_cloud_token_response.json.data.data.token }}"

    - name: Fetch OAuth token
      uri:
        url: "{{ vault_addr }}/v1/secret/data/oauth-token"
        method: GET
        headers:
          "X-Vault-Token": "{{ vault_token }}"
        return_content: yes
      register: oauth_token_response

    - name: Set OAuth token
      set_fact:
        oauth_token: "{{ oauth_token_response.json.data.data.token }}"

    - name: Register GitHub module to Terraform Cloud
      uri:
        url: "https://app.terraform.io/api/v2/organizations/{{ terraform_cloud_org }}/registry-modules"
        method: POST
        headers:
          "Authorization": "Bearer {{ terraform_cloud_token }}"
          "Content-Type": "application/vnd.api+json"
        body_format: json
        body:
          data:
            type: "registry-modules"
            attributes:
              name: "{{ terraform_cloud_module_name }}"
              provider: "{{ terraform_cloud_module_provider }}"
              vcs_repo:
                identifier: "{{ github_repo }}"
                oauth_token_id: "{{ oauth_token }}"
        return_content: yes
      register: publish_response

    - name: Output publish response
      debug:
        var: publish_response
